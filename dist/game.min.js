function Door(t){return t=t||{},this.name=t.name||"DOOR",this.glyph="d",this.layer=t.layer||0,this.id=t.id||0,this.x=t.x||0,this.y=t.y||0,this.state=t.state||STATE_NORMAL,this.dest=t.dest||0,this}function Pickup(t){return t=t||{},this.name=t.name||"PICKUP",this.glyph="p",this.layer=t.layer||0,this.id=t.id||0,this.x=t.x||0,this.y=t.y||0,this.state=t.state||STATE_NORMAL,this}function Actor(t){t=t||{};var e=t.id||0;return this.name=t.name||"ACTOR",this.glyph="a",this.layer=t.layer||0,this.x=t.x||0,this.y=t.y||0,this.state=t.state||STATE_NORMAL,this.hp=1,0==e?(this.glyph="@",this.hp=3):this.hp=prng.getInt(2,1),this.id=e,this}function Layer(t){return t=t||{},this.width=t.W||10,this.height=t.H||10,this.id=t.id||this.uuid(),this.thing=!!t.T&&t.T||!1,this.numThings=t.N||10,this.map=[],this.things=[],this.empty(),this}function Player(t){return t=t||{},this.hp=t.hp||3,this.inventory=t.inventory||[],this.max_scroll=t.maxScroll||3,this.max_potion=t.maxPotion||3,this.max_gold=t.maxGold||10,this}function Engine(t){return t=t||{},this.seed=t.seed||4242,this.width=t.W||10,this.height=t.H||10,this.numDoors=t.D||1,this.numPickups=t.P||3,this.numActors=t.A||10,this.layers=[],this.doors=[],this.pickups=[],this.actors=[],this.player=new Player,"undefined"!=typeof t.debug&&(DEBUG=t.debug),window.addEventListener("keydown",this.handleInputs),_$("#died button").addEventListener("click",function(){window.location.reload()}),this.setSeed(seed),this}function _$(t){return document.querySelector(t)}!function(){var t=function(){var t=function(t){this.x=0,this.w=0,this.s=t&&t.seed||1168985806,this.maxPrecision=t&&t.maxPrecision||10};return t.prototype.getSeed=function(){return this.s},t.prototype.setSeed=function(t){this.s=t},t.prototype.msws=function(t,e){var i=!!t,n=!1,s=0;for(t=t||1,e=e||0;!n;){s+=1,this.x*=this.x,this.x+=this.w+=this.s,this.x=this.x>>16|this.x<<16,this.x=this.x<0?this.x*-1:this.x;var r=i&&(this.x>t||e&&this.x<e);i?r||(n=!0):n=!0}return this.x},t.prototype.getInt=function(t,e){return this.msws(t,e)},t.prototype.getFloat=function(t,e){e=e||0,t=t||1;var i=1===t?0:this.getInt(t-1,e),n=this.getInt(1+"0".repeat(this.maxPrecision)),s=+i+"."+n;return s},t.prototype.getFixed=function(t,e,i){return t=t||2,i=i||0,e=e||1,t=t>=this.maxPrecision?this.maxPrecision:t,new Number(this.getFloat(e,i)).toFixed(t)},t.prototype.random=function(){return this.getFloat(1,0)},t}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=t:window.MSWS=t}(),window.setSeed=function(t){window.prng=new MSWS,window.seed=t,prng.setSeed(t)},setSeed(4242),STATE_NORMAL=0,Door.prototype.getName=function(t){var e=["Door"];return e[0]},Door.prototype.trigger=function(){var t=this.dest;setTimeout(function(){console.log("teleporting from %s to %s",engine.seed,t),engine.setSeed(t)},0)},STATE_NORMAL=0,Pickup.prototype.getName=function(t){var e,i=["Potion","Scroll","Gold"],n=prng.getInt(100,1)-1;return e=n<35?0:n<70?1:2,i[e]},Pickup.prototype.trigger=function(){engine.player.addItem(this.name)&&(engine.layers[2].map[this.y][this.x]=" ",engine.pickups[this.id]=void 0)},STATE_NORMAL=0,STATE_AGITATED=1,Actor.prototype.agitate=function(){0!=this.id&&(this.state=STATE_AGITATED,this.glyph="A",engine.layers[3].map[y][x]=this.glyph,engine.layers[3].render())},Actor.prototype.calm=function(){0!=this.id&&(this.state=STATE_NORMAL,this.glyph="a",engine.layers[3].map[y][x]=this.glyph,engine.layers[3].render())},Actor.prototype.move=function(t,e,i){var n=this.id,s=this.x+t,r=this.y+e;if(0==n&&!i)return!1;if(Math.abs(t)>1||Math.abs(e)>1)return console.warn("WARN: actor movement range is out of range, got: %s, %s",t,e),!1;s<0&&(s=0),s>engine.width&&(s=engine.width),r<0&&(r=0),r>engine.height&&(r=engine.height);var o=engine.layers[0].map[r][s],h=engine.layers[1].map[r][s],a=engine.layers[2].map[r][s],p=engine.layers[3].map[r][s];if(i){if("d"==h.toLowerCase()&&engine.doors.forEach(function(t){r==t.y&&s==t.x&&t.trigger(this)}),"p"==a.toLowerCase()&&engine.pickups.forEach(function(t){t&&r==t.y&&s==t.x&&t.trigger(this)}),"a"==p.toLowerCase())return engine.actors.forEach(function(t){t&&r==t.y&&s==t.x&&t.hit(this)}),!0}else{if("@"==p)return engine.player.hit(this),!0;if("a"==p.toLowerCase()){var c=this;return engine.actors.forEach(function(t){t&&r==t.y&&s==t.x&&t.hit(c)}),!0}}return"#"!=o&&(engine.layers[this.layer].map[this.y][this.x]=" ",this.x=s,this.y=r,engine.layers[this.layer].map[this.y][this.x]=this.glyph,engine.layers[this.layer].render()),!0},Actor.prototype.getName=function(t){var e=["Player","Actor1","Actor2","Actor3","Actor4","Actor5","Actor6","Actor7"];return this.id<e.length?e[this.id]:"Extra Actor"},Actor.prototype.hit=function(t){t.engine&&(t=engine.actors[0]),console.log("actor %s hit actor %s",t.id,this.id),this.hp-=1,this.hp<=0&&(this.hp=0,this.die())},Actor.prototype.die=function(){console.log("actor %s died",this.id),engine.layers[3].map[this.y][this.x]=" ",engine.actors[this.id]=void 0},Layer.prototype.uuid=function(){return 0},Layer.prototype.empty=function(){this.map=[];for(var t=0;t<this.height;t++){this.map.push([]);for(var e=0;e<this.width;e++)this.map[t][e]=" "}return this.id},Layer.prototype.from=function(t){switch(typeof t){case"string":console.warn("STUB: from(rendered)");break;case"object":console.warn("STUB: from(AoA)");break;default:console.warn("Layer.from(): Unsupported layer source")}},Layer.prototype.generate=function(e){var i=x=y=p=a=0;if(this.thing){if("object"!=typeof e)return console.warn("WARN: invalid floorsAndWalls map"),!1;for(t=0;t<this.numThings;t++)for(i=!0,x=y=0;i;)if(x=prng.getInt(this.width-1,0),y=prng.getInt(this.height-1,0),"#"!=e[y][x]){this.things[t]=new this.thing({layer:this.id,id:t,x:x,y:y});var n=this.things[t].getName(t);this.things[t].name=n,i=!1,this.map[y][x]=this.things[t].glyph||"?"}}else for(y=0;y<this.height;y++)for(x=0;x<this.width;x++){var s="";s=0==y||y==this.height-1||0==x||x==this.width-1?"#":+prng.getFixed(2,1,0)>.75?"#":".",this.map[y][x]=s}return this.render()},Layer.prototype.render=function(){for(var t="",e=0;e<this.height;e++){for(var i=0;i<this.width;i++)t+=this.map[e][i];t+="\n"}return t},Player.prototype.hit=function(t){console.log("actor %s hit player",t.id),this.hp-=1,this.hp<=0&&(this.hp=0,this.die()),_$("#hp").innerText=this.hp},Player.prototype.canTake=function(t){var e=[],i="max_"+t.toLowerCase(),n=this[i];return e=this.inventory.filter(function(e){return e==t}),!e.length||!!(n&&e.length<n)},Player.prototype.addItem=function(t){if(this.canTake(t)){var e=[];return this.inventory.push(t),_$("#message").innerText="You found a "+t,e=this.inventory.filter(function(e){return e==t}),_$("#"+t.toLowerCase()).innerText=e.length,!0}return _$("#message").innerText="Can't take "+t,!1},Player.prototype.die=function(){engine.showScreen("died")},DEBUG=!0,LYR_FLOORSWALLS=0,LYR_DOORS=1,LYR_PICKUPS=2,LYR_ACTORS=3,KEY_W=87,KEY_Z=90,KEY_UP=38,KEY_A=65,KEY_Q=81,KEY_LEFT=37,KEY_S=83,KEY_DOWN=40,KEY_D=68,KEY_RIGHT=39,KEY_SPACE=32,KEY_ENTER=13,Engine.prototype.setSeed=function(t){this.seed=t,window.setSeed(t),this.generateLayers(),this.render()},Engine.prototype.teardown=function(){this.layers=[],this.doors=[],this.pickups=[],this.actors=[]},Engine.prototype.generateLayers=function(){this.layers.length>0&&this.teardown(),this.layers.push(new Layer({id:LYR_FLOORSWALLS,W:this.width,H:this.height})),this.layers[LYR_FLOORSWALLS].generate(),this.layers.push(new Layer({id:LYR_DOORS,W:this.width,H:this.height,N:this.numDoors,T:Door})),this.layers[LYR_DOORS].generate(this.layers[LYR_FLOORSWALLS].map),this.doors=this.layers[LYR_DOORS].things,this.doors.forEach(function(t){t.dest=4242+prng.getInt(1e3,1)}),this.layers.push(new Layer({id:LYR_PICKUPS,W:this.width,H:this.height,N:this.numPickups,T:Pickup})),this.layers[LYR_PICKUPS].generate(this.layers[LYR_FLOORSWALLS].map),this.pickups=this.layers[LYR_PICKUPS].things,this.layers.push(new Layer({id:LYR_ACTORS,W:this.width,H:this.height,N:this.numActors,T:Actor})),this.layers[LYR_ACTORS].generate(this.layers[LYR_FLOORSWALLS].map),this.actors=this.layers[LYR_ACTORS].things},Engine.prototype.handleInputs=function(t){switch(_$("#message").innerText="",t.which){case KEY_W:case KEY_Z:case KEY_UP:engine.actors[0].move(0,-1,!0);break;case KEY_A:case KEY_Q:case KEY_LEFT:engine.actors[0].move(-1,0,!0);break;case KEY_S:case KEY_DOWN:engine.actors[0].move(0,1,!0);break;case KEY_D:case KEY_RIGHT:engine.actors[0].move(1,0,!0);break;case KEY_SPACE:console.log("space");break;case KEY_ENTER:console.log("enter")}engine.render(),engine.aiTurn()},Engine.prototype.aiTurn=function(){this.actors.forEach(function(t){if(t&&0!=t.id){var e=prng.getInt(4,1)-1;DEBUG&&console.log("  actor %s move direction: %s",t.id,e),0==e&&t.move(0,-1),1==e&&t.move(-1,0),2==e&&t.move(0,1),3==e&&t.move(1,0)}}),this.render()},Engine.prototype.mergeLayers=function(){var t=new Layer({W:this.width,H:this.height}),e="";DEBUG&&console.groupCollapsed("mergeLayer");for(var i=0;i<this.height;i++){for(var n=0;n<this.width;n++){switch(t.map[i][n]=this.layers[LYR_FLOORSWALLS].map[i][n],DEBUG&&console.log('FW: tmpLayer.map[%s][%s]: "%s"',i,n,t.map[i][n]),t.map[i][n]){case" ":case".":case"~":" "!=this.layers[LYR_DOORS].map[i][n]&&(t.map[i][n]=this.layers[LYR_DOORS].map[i][n])," "!=this.layers[LYR_PICKUPS].map[i][n]&&(t.map[i][n]=this.layers[LYR_PICKUPS].map[i][n])," "!=this.layers[LYR_ACTORS].map[i][n]&&(t.map[i][n]=this.layers[LYR_ACTORS].map[i][n]),DEBUG&&console.log('PA: tmpLayer[%s][%s]: "%s"',i,n,t.map[i][n])}e+=t.map[i][n]}e+="\n"}return DEBUG&&console.groupEnd(),e},Engine.prototype.render=function(){var t=this.mergeLayers();return DEBUG&&(console.groupCollapsed("render"),console.log(t),console.groupEnd()),stage.innerText=t,t},Engine.prototype.showScreen=function(t){switch(t){case"game":_$("#game").style.display="block",_$("#died").style.display="none";break;case"died":_$("#game").style.display="none",_$("#died").style.display="block"}},window.addEventListener("load",function(){window.engine=new Engine({W:20,H:10,D:1,A:10,P:3,debug:!1,seed:4242}),_$("#btn_up").addEventListener("click",function(){engine.handleInputs({which:87})}),_$("#btn_lt").addEventListener("click",function(){engine.handleInputs({which:65})}),_$("#btn_dn").addEventListener("click",function(){engine.handleInputs({which:83})}),_$("#btn_rt").addEventListener("click",function(){engine.handleInputs({which:68})}),engine.render()});
