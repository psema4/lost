function _$(e){return document.querySelector(e)}function _$$(e){return document.querySelectorAll(e)}function Door(e){return e=e||{},this.name=e.name||"DOOR",this.glyph="d",this.layer=e.layer||0,this.id=e.id||0,this.x=e.x||0,this.y=e.y||0,this.state=e.state||STATE_NORMAL,this.dest=e.dest||0,this}function Pickup(e){return e=e||{},this.name=e.name||"PICKUP",this.glyph="p",this.layer=e.layer||0,this.id=e.id||0,this.x=e.x||0,this.y=e.y||0,this.state=e.state||STATE_NORMAL,this}function Actor(e){e=e||{};var t=e.id||0;return this.name=e.name||"ACTOR",this.glyph="a",this.layer=e.layer||0,this.x=e.x||0,this.y=e.y||0,this.state=e.state||STATE_NORMAL,this.hp=1,0==t?(this.glyph="@",this.hp=3):this.hp=prng.getInt(2,1),this.id=t,this}function Layer(e){return e=e||{},this.width=e.W||10,this.height=e.H||10,this.id=e.id||this.uuid(),this.thing=!!e.T&&e.T||!1,this.numThings=e.N||10,this.map=[],this.things=[],this.empty(),this}function Player(e){return e=e||{},this.hp=e.hp||3,this.hpMax=e.hpMax||3,this.inventory=e.inventory||[],this.max_scroll=e.maxScroll||3,this.max_potion=e.maxPotion||3,this.max_gold=e.maxGold||10,this}function Engine(e){e=e||{};var t;if(this.seed=e.seed||4242,this.width=e.W||10,this.height=e.H||10,this.numDoors=e.D||1,this.numPickups=e.P||3,this.numActors=e.A||10,this.layers=[],this.doors=[],this.pickups=[],this.actors=[],this.player=new Player,this.mode="start",this.menu=[],this.menuSelection=0,"undefined"!=typeof e.debug&&(DEBUG=e.debug),window.addEventListener("keydown",this.handleInputs),this.setSeed(seed),!e.hasStarted)for(var i=0;i<this.height;i++)for(var n=0;n<this.width;n++)t=document.createElement("span"),t.id="C"+i+"_"+n,t.className="sprite",t.style.top=20*i+"px",t.style.left=15*n+"px",_$("#stage2d").appendChild(t);return this.player.updateGameUI(),this.player.updateInventoryUI(),_$("#room").innerText=0,this}function startNewGame(e){setSeed(4242),window.engine=new Engine({W:20,H:10,D:1,A:10,P:3,debug:!1,seed:4242,hasStarted:e}),engine.render(),e?engine.showScreen("intro"):setTimeout(function(){engine.showScreen("mainmenu")},3e3)}!function(){var e=function(){var e=function(e){this.x=0,this.w=0,this.s=e&&e.seed||1168985806,this.maxPrecision=e&&e.maxPrecision||10};return e.prototype.getSeed=function(){return this.s},e.prototype.setSeed=function(e){this.s=e},e.prototype.msws=function(e,t){var i=!!e,n=!1,s=0;for(e=e||1,t=t||0;!n;){s+=1,this.x*=this.x,this.x+=this.w+=this.s,this.x=this.x>>16|this.x<<16,this.x=this.x<0?this.x*-1:this.x;var r=i&&(this.x>e||t&&this.x<t);i?r||(n=!0):n=!0}return this.x},e.prototype.getInt=function(e,t){return this.msws(e,t)},e.prototype.getFloat=function(e,t){t=t||0,e=e||1;var i=1===e?0:this.getInt(e-1,t),n=this.getInt(1+"0".repeat(this.maxPrecision)),s=+i+"."+n;return s},e.prototype.getFixed=function(e,t,i){return e=e||2,i=i||0,t=t||1,e=e>=this.maxPrecision?this.maxPrecision:e,new Number(this.getFloat(t,i)).toFixed(e)},e.prototype.random=function(){return this.getFloat(1,0)},e}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=e:window.MSWS=e}(),window.setSeed=function(e){window.prng=new MSWS,window.seed=e,prng.setSeed(e)},setSeed(4242),STATE_NORMAL=0,Door.prototype.getName=function(e){var t=["Door"];return t[0]},Door.prototype.trigger=function(){var e=this.dest;setTimeout(function(){console.log("teleporting from %s to %s",engine.seed,e),engine.setSeed(e);var t=+_$("#room").innerText;_$("#room").innerText=t+1+""},0)},STATE_NORMAL=0,Pickup.prototype.getName=function(e){var t,i=["Potion","Scroll","Gold"],n=prng.getInt(100,1)-1;return t=n<35?0:n<70?1:2,i[t]},Pickup.prototype.trigger=function(){engine.player.addItem(this.name)&&(engine.layers[2].map[this.y][this.x]=" ",engine.pickups[this.id]=void 0)},STATE_NORMAL=0,STATE_AGITATED=1,Actor.prototype.agitate=function(){0!=this.id&&(this.state=STATE_AGITATED,this.glyph="A",engine.layers[3].map[y][x]=this.glyph,engine.layers[3].render())},Actor.prototype.calm=function(){0!=this.id&&(this.state=STATE_NORMAL,this.glyph="a",engine.layers[3].map[y][x]=this.glyph,engine.layers[3].render())},Actor.prototype.move=function(e,t,i){var n=this.id,s=this.x+e,r=this.y+t;if(0==n&&!i)return!1;if(Math.abs(e)>1||Math.abs(t)>1)return console.warn("WARN: actor movement range is out of range, got: %s, %s",e,t),!1;s<0&&(s=0),s>engine.width&&(s=engine.width),r<0&&(r=0),r>engine.height&&(r=engine.height);var o=engine.layers[0].map[r][s],h=engine.layers[1].map[r][s],a=engine.layers[2].map[r][s],c=engine.layers[3].map[r][s];if(i){if("d"==h.toLowerCase()&&engine.doors.forEach(function(e){r==e.y&&s==e.x&&e.trigger(this)}),"p"==a.toLowerCase()&&engine.pickups.forEach(function(e){e&&r==e.y&&s==e.x&&e.trigger(this)}),"a"==c.toLowerCase())return engine.actors.forEach(function(e){e&&r==e.y&&s==e.x&&e.hit(this)}),!0}else{if("@"==c)return engine.player.hit(this),!0;if("a"==c.toLowerCase()){var p=this;return engine.actors.forEach(function(e){e&&r==e.y&&s==e.x&&e.hit(p)}),!0}}return"#"!=o&&(engine.layers[this.layer].map[this.y][this.x]=" ",this.x=s,this.y=r,engine.layers[this.layer].map[this.y][this.x]=this.glyph,engine.layers[this.layer].render()),!0},Actor.prototype.getName=function(e){var t=["Player","Actor1","Actor2","Actor3","Actor4","Actor5","Actor6","Actor7"];return this.id<t.length?t[this.id]:"Extra Actor"},Actor.prototype.hit=function(e){e.engine&&(e=engine.actors[0]),console.log("actor %s hit actor %s",e.id,this.id),this.hp-=1,this.hp<=0&&(this.hp=0,this.die())},Actor.prototype.die=function(){console.log("actor %s died",this.id),engine.layers[3].map[this.y][this.x]=" ",engine.actors[this.id]=void 0},Layer.prototype.uuid=function(){return 0},Layer.prototype.empty=function(){this.map=[];for(var e=0;e<this.height;e++){this.map.push([]);for(var t=0;t<this.width;t++)this.map[e][t]=" "}return this.id},Layer.prototype.from=function(e){switch(typeof e){case"string":console.warn("STUB: from(rendered)");break;case"object":console.warn("STUB: from(AoA)");break;default:console.warn("Layer.from(): Unsupported layer source")}},Layer.prototype.generate=function(e){var i=x=y=p=a=0;if(this.thing){if("object"!=typeof e)return console.warn("WARN: invalid floorsAndWalls map"),!1;for(t=0;t<this.numThings;t++)for(i=!0,x=y=0;i;)if(x=prng.getInt(this.width-1,0),y=prng.getInt(this.height-1,0),"#"!=e[y][x]&&" "==this.map[y][x]){this.things[t]=new this.thing({layer:this.id,id:t,x:x,y:y});var n=this.things[t].getName(t);this.things[t].name=n,i=!1,this.map[y][x]=this.things[t].glyph||"?"}}else for(y=0;y<this.height;y++)for(x=0;x<this.width;x++){var s="";s=0==y||y==this.height-1||0==x||x==this.width-1?"#":+prng.getFixed(2,1,0)>.75?"#":".",this.map[y][x]=s}return this.render()},Layer.prototype.render=function(){for(var e="",t=0;t<this.height;t++){for(var i=0;i<this.width;i++)e+=this.map[t][i];e+="\n"}return e},Player.prototype.hit=function(e){console.log("actor %s hit player",e.id),this.hp-=1,this.hp<=0&&(this.hp=0,this.die()),_$("#hp").innerText=this.hp},Player.prototype.canTake=function(e){var t=[],i="max_"+e.toLowerCase(),n=this[i];return t=this.inventory.filter(function(t){return t==e}),!t.length||!!(n&&t.length<n)},Player.prototype.addItem=function(e,t){return this.canTake(e)?(this.inventory.push(e),t||(_$("#message").innerText="You found a "+e),this.updateGameUI(),this.updateInventoryUI(),!0):(t||(_$("#message").innerText="Can't take "+e),!1)},Player.prototype.updateGameUI=function(){var e=[],t=["Potion","Scroll","Gold"],i=this.inventory;t.forEach(function(t){e=i.filter(function(e){return e==t}),_$("#"+t.toLowerCase()).innerText=e.length}),_$("#hp").innerText=this.hp},Player.prototype.updateInventoryUI=function(){var e=[],t=[];_$("#items").innerHTML="",this.inventory.forEach(function(t){"undefined"==typeof e[t]&&(e[t]={name:t,count:0}),e[t].count+=1}),t=Object.keys(e),t.forEach(function(t){var i=e[t];_$("#items").innerHTML+="<li>"+i.count+" x <button onclick=\"engine.player.use('"+i.name+"')\">"+i.name+"</button></li>"})},Player.prototype.addHealth=function(e){this.hp+=e,this.hp>this.hpMax&&(this.hp=this.hpMax)},Player.prototype.die=function(){_$("#died_in_room").innerText=_$("#room").innerText,engine.showScreen("died")},Player.prototype.use=function(e){var t=-1;if(this.inventory.forEach(function(i,n){i.toLowerCase()===e.toLowerCase()&&(t=n)}),t>-1){var e=this.inventory.splice(t,1)[0];switch(e.toLowerCase()){case"scroll":_$("#message").innerText="You use a "+e,engine.actors.forEach(function(e,t){0!=t&&void 0!=e&&e.hit(engine.actors[0])}),engine.render();break;case"potion":_$("#message").innerText="You drink a "+e,this.addHealth(this.hpMax);break;case"gold":default:_$("#message").innerText="You can't use "+e+" right now.",this.addItem(e,!0)}}this.updateGameUI(),this.updateInventoryUI(),engine.showScreen("game")},DEBUG=!0,LYR_FLOORSWALLS=0,LYR_DOORS=1,LYR_PICKUPS=2,LYR_ACTORS=3,KEY_W=87,KEY_Z=90,KEY_UP=38,KEY_A=65,KEY_Q=81,KEY_LEFT=37,KEY_S=83,KEY_DOWN=40,KEY_D=68,KEY_RIGHT=39,KEY_SPACE=32,KEY_ENTER=13,Engine.prototype.setSeed=function(e){this.seed=e,window.setSeed(e),this.generateLayers(),this.render()},Engine.prototype.teardown=function(){this.layers=[],this.doors=[],this.pickups=[],this.actors=[]},Engine.prototype.generateLayers=function(){this.layers.length>0&&this.teardown(),this.layers.push(new Layer({id:LYR_FLOORSWALLS,W:this.width,H:this.height})),this.layers[LYR_FLOORSWALLS].generate(),this.layers.push(new Layer({id:LYR_DOORS,W:this.width,H:this.height,N:this.numDoors,T:Door})),this.layers[LYR_DOORS].generate(this.layers[LYR_FLOORSWALLS].map),this.doors=this.layers[LYR_DOORS].things,this.doors.forEach(function(e){e.dest=4242+prng.getInt(1e3,1)}),this.layers.push(new Layer({id:LYR_PICKUPS,W:this.width,H:this.height,N:this.numPickups,T:Pickup})),this.layers[LYR_PICKUPS].generate(this.layers[LYR_FLOORSWALLS].map),this.pickups=this.layers[LYR_PICKUPS].things,this.layers.push(new Layer({id:LYR_ACTORS,W:this.width,H:this.height,N:this.numActors,T:Actor})),this.layers[LYR_ACTORS].generate(this.layers[LYR_FLOORSWALLS].map),this.actors=this.layers[LYR_ACTORS].things},Engine.prototype.isMode=function(e){return e===this.mode},Engine.prototype.handleInputs=function(e){var t="game"===engine.mode;switch(isMenu=["mainmenu","intro","inventory","died"].includes(engine.mode),t&&(_$("#message").innerText=""),e.which){case KEY_W:case KEY_Z:case KEY_UP:t&&engine.actors[0].move(0,-1,!0),isMenu&&engine.selectPrevious();break;case KEY_A:case KEY_Q:case KEY_LEFT:t&&engine.actors[0].move(-1,0,!0),isMenu&&engine.selectPrevious();break;case KEY_S:case KEY_DOWN:t&&engine.actors[0].move(0,1,!0),isMenu&&engine.selectNext();break;case KEY_D:case KEY_RIGHT:t&&engine.actors[0].move(1,0,!0),isMenu&&engine.selectNext();break;case KEY_SPACE:break;case KEY_ENTER:t&&engine.showScreen("inventory"),isMenu&&engine.activateSelected()}t&&(engine.render(),engine.aiTurn())},Engine.prototype.selectPrevious=function(){var e;this.menuSelection-=1,this.menuSelection<0&&(this.menuSelection=this.menu.length-1),e=_$$("#"+engine.mode+" button"),e.forEach(function(e){e.classList.remove("highlight")}),this.menu[this.menuSelection].classList.add("highlight")},Engine.prototype.selectNext=function(){var e;this.menuSelection+=1,this.menuSelection>=this.menu.length&&(this.menuSelection=0),e=_$$("#"+engine.mode+" button"),e.forEach(function(e){e.classList.remove("highlight")}),this.menu[this.menuSelection].classList.add("highlight")},Engine.prototype.activateSelected=function(){var el=this.menu[this.menuSelection],fn=el&&el.getAttribute("onclick");fn&&"string"==typeof fn&&eval(fn)},Engine.prototype.aiTurn=function(){this.actors.forEach(function(e){if(e&&0!=e.id){var t=prng.getInt(4,1)-1;DEBUG&&console.log("  actor %s move direction: %s",e.id,t),0==t&&e.move(0,-1),1==t&&e.move(-1,0),2==t&&e.move(0,1),3==t&&e.move(1,0)}}),this.render()},Engine.prototype.mergeLayers=function(){var e=new Layer({W:this.width,H:this.height}),t="";DEBUG&&console.groupCollapsed("mergeLayer");for(var i=0;i<this.height;i++){for(var n=0;n<this.width;n++){switch(e.map[i][n]=this.layers[LYR_FLOORSWALLS].map[i][n],DEBUG&&console.log('FW: tmpLayer.map[%s][%s]: "%s"',i,n,e.map[i][n]),e.map[i][n]){case" ":case".":case"~":" "!=this.layers[LYR_DOORS].map[i][n]&&(e.map[i][n]=this.layers[LYR_DOORS].map[i][n])," "!=this.layers[LYR_PICKUPS].map[i][n]&&(e.map[i][n]=this.layers[LYR_PICKUPS].map[i][n])," "!=this.layers[LYR_ACTORS].map[i][n]&&(e.map[i][n]=this.layers[LYR_ACTORS].map[i][n]),DEBUG&&console.log('PA: tmpLayer[%s][%s]: "%s"',i,n,e.map[i][n])}t+=e.map[i][n]}t+="\n"}return DEBUG&&console.groupEnd(),t},Engine.prototype.render=function(){var e=this.mergeLayers();if(DEBUG&&(console.groupCollapsed("render"),console.log(e),console.groupEnd()),stage.innerText=e,!_$("#C0_0"))return e;for(var t=e.split(/\n/),i=0;i<this.height;i++)for(var n=t[i],s=n.split(""),r=0;r<this.width;r++){var o=s[r],h="",a="#";switch(o){case".":h="ground0";break;case"#":h="wall0";break;case"@":h="actor0 up frame1";break;case"a":h="actor1 up frame1";break;case"p":h="pickup0";break;case"d":default:h="ground1"}a+="C"+i+"_"+r,_$(a).className="sprite "+h}return e},Engine.prototype.hideScreens=function(){var e=_$$(".screen");e.forEach(function(e){e.style.display="none"})},Engine.prototype.showScreen=function(e){this.hideScreens(),_$("#"+e).style.display="block",this.mode=e,this.menu=_$$("#"+e+" button"),this.menuSelection=0,"game"!==e&&this.menu[this.menuSelection].classList.add("highlight")},window.addEventListener("load",function(){_$("#btn_up").addEventListener("click",function(){engine.handleInputs({which:87})}),_$("#btn_lt").addEventListener("click",function(){engine.handleInputs({which:65})}),_$("#btn_dn").addEventListener("click",function(){engine.handleInputs({which:83})}),_$("#btn_rt").addEventListener("click",function(){engine.handleInputs({which:68})}),startNewGame(!1)});
