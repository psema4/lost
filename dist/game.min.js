function Actor(e){function t(){0!=this.id&&(this.state=STATE_AGITATED,this.glyph="A",engine.layers[a].map[p][g]=this.glyph,engine.layers[this.layer].render())}function n(){0!=this.id&&(this.state=STATE_NORMAL,this.glyph="a",engine.layers[a].map[p][g]=this.glyph,engine.layers[this.layer].render())}function r(e,t){var n=this.x+e,r=this.y+t;if(Math.abs(e)>1||Math.abs(t)>1)return console.warn("WARN: actor movement range is out of range, got: %s, %s",e,t),!1;n<0&&(n=0),n>engine.width&&(n=engine.width),r<0&&(r=0),r>engine.height&&(r=engine.height);var o=engine.layers[0].map[r][n];return"#"!=o&&(engine.layers[this.layer].map[this.y][this.x]=" ",this.x=n,this.y=r,engine.layers[this.layer].map[this.y][this.x]=this.glyph,engine.layers[this.layer].render()),!0}function o(e){var t=["Player","Actor1","Actor2","Actor3","Actor4","Actor5","Actor6","Actor7"];return e<t.length?t[e]:"Extra Actor"}e=e||{};var i=(e.prng||new MSWS,e.seed||(new Date).getTime(),e.name||"ACTOR"),s="a",a=e.layer||0,c=e.id||0,g=e.x||0,p=e.y||0,h=e.state||STATE_NORMAL;return 0==c&&(s="@"),{name:i,glyph:s,layer:a,id:c,x:g,y:p,state:h,agitate:t,calm:n,move:r,getName:o}}function Pickup(e){function t(e){var t,r=["Potion","Scroll","Sword","Gold"],o=n.getInt(100,1)-1;return t=o<35?0:o<70?1:o<90?2:3,r[t]}e=e||{};var n=e.prng||new MSWS,r=(e.seed||(new Date).getTime(),e.name||"PICKUP"),o="p",i=e.layer||0,s=e.id||0,a=e.x||0,c=e.y||0,g=e.state||STATE_NORMAL;return{name:r,glyph:o,layer:i,id:s,x:a,y:c,state:g,getName:t}}function Layer(e){function n(){return 0}function r(){function e(){return" ".repeat(h).split("")}for(var t=0;t<u;t++)f.push(e());return d}function o(e){switch(typeof e){case"string":console.warn("STUB: from(rendered)");break;case"object":console.warn("STUB: from(AoA)");break;default:console.warn("Layer.from(): Unsupported layer source")}}function i(e){var n=x=y=p=a=0;if(l){if("object"!=typeof e)return console.warn("WARN: invalid floorsAndWalls map"),!1;for(t=0;t<m;t++)for(n=!0,x=y=0;n;)if(x=c.getInt(h-1,0),y=c.getInt(u-1,0),"#"!=e[y][x]){E[t]=new l({layer:this.id,id:t,x:x,y:y,prng:c,seed:g});var r=E[t].getName(t);E[t].name=r,n=!1,f[y][x]=E[t].glyph||"?"}}else for(y=0;y<u;y++)for(x=0;x<h;x++){var o="";o=0==y||y==u-1||0==x||x==h-1?"#":+c.getFixed(2,1,0)>.75?"#":".",f[y][x]=o}return s()}function s(){for(var e="",t=0;t<u;t++){for(var n=0;n<h;n++)e+=f[t][n];e+="\n"}return e}e=e||{};var c=e.prng||new MSWS,g=e.seed||(new Date).getTime(),h=e.W||10,u=e.H||10,d=e.id||n(),l=!!e.T&&e.T||!1,m=e.N||10,f=[],E=[];return c.setSeed(g),r(),{opts:e,id:d,map:f,thing:l,things:E,uuid:n,empty:r,from:o,generate:i,render:s}}function Engine(e){function t(){for(var e=1;e<u.length;e++){var t=o.getInt(4,1);0==t&&u[e].move(0,-1),1==t&&u[e].move(-1,0),2==t&&u[e].move(0,1),3==t&&u[e].move(1,0),DEBUG&&console.log("actor[%s] move direction: %s",e,t)}r()}function n(){var e=new Layer({W:s,H:a,prng:o,seed:i}),t="";DEBUG&&console.groupCollapsed("mergeLayer");for(var n=0;n<a;n++){for(var r=0;r<s;r++){switch(e.map[n][r]=p[LYR_FLOORSWALLS].map[n][r],DEBUG&&console.log('FW: tmpLayer.map[%s][%s]: "%s"',n,r,e.map[n][r]),e.map[n][r]){case" ":case".":case"~":" "!=p[LYR_PICKUPS].map[n][r]&&(e.map[n][r]=p[LYR_PICKUPS].map[n][r])," "!=p[LYR_ACTORS].map[n][r]&&(e.map[n][r]=p[LYR_ACTORS].map[n][r]),DEBUG&&console.log('PA: tmpLayer[%s][%s]: "%s"',n,r,e.map[n][r])}t+=e.map[n][r]}t+="\n"}return DEBUG&&console.groupEnd(),t}function r(){var e=n();return DEBUG&&(console.groupCollapsed("render"),console.log(e),console.groupEnd()),stage.innerText=e,e}e=e||{};var o=e.prng||new MSWS,i=e.seed||(new Date).getTime(),s=e.W||10,a=e.H||10,c=e.P||3,g=e.A||10,p=[],h=[],u=[];return"undefined"!=typeof e.debug&&(DEBUG=e.debug),o.setSeed(i),p.push(new Layer({id:LYR_FLOORSWALLS,W:s,H:a,prng:o,seed:i})),p[LYR_FLOORSWALLS].generate(),p.push(new Layer({id:LYR_PICKUPS,W:s,H:a,N:c,T:Pickup,prng:o,seed:i})),p[LYR_PICKUPS].generate(p[LYR_FLOORSWALLS].map),h=p[LYR_PICKUPS].things,p.push(new Layer({id:LYR_ACTORS,W:s,H:a,N:g,T:Actor,prng:o,seed:i})),p[LYR_ACTORS].generate(p[LYR_FLOORSWALLS].map),u=p[LYR_ACTORS].things,window.addEventListener("keydown",function(e){switch(e.which){case KEY_W:case KEY_Z:case KEY_UP:u[0].move(0,-1),r();break;case KEY_A:case KEY_Q:case KEY_LEFT:u[0].move(-1,0),r();break;case KEY_S:case KEY_DOWN:u[0].move(0,1),r();break;case KEY_D:case KEY_RIGHT:u[0].move(1,0),r();break;case KEY_SPACE:console.log("space");break;case KEY_ENTER:console.log("enter")}t()}),{opts:e,width:s,height:a,layers:p,pickups:h,actors:u,render:r}}!function(){var e=function(){var e=function(e){this.x=0,this.w=0,this.s=e&&e.seed||1168985806,this.maxPrecision=e&&e.maxPrecision||10};return e.prototype.getSeed=function(){return this.s},e.prototype.setSeed=function(e){this.s=e},e.prototype.msws=function(e,t){var n=!!e,r=!1,o=0;for(e=e||1,t=t||0;!r;){o+=1,this.x*=this.x,this.x+=this.w+=this.s,this.x=this.x>>16|this.x<<16,this.x=this.x<0?this.x*-1:this.x;var i=n&&(this.x>e||t&&this.x<t);n?i||(r=!0):r=!0}return this.x},e.prototype.getInt=function(e,t){return this.msws(e,t)},e.prototype.getFloat=function(e,t){t=t||0,e=e||1;var n=1===e?0:this.getInt(e-1,t),r=this.getInt(1+"0".repeat(this.maxPrecision)),o=+n+"."+r;return o},e.prototype.getFixed=function(e,t,n){return e=e||2,n=n||0,t=t||1,e=e>=this.maxPrecision?this.maxPrecision:e,new Number(this.getFloat(t,n)).toFixed(e)},e.prototype.random=function(){return this.getFloat(1,0)},e}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=e:window.MSWS=e}(),STATE_NORMAL=0,STATE_AGITATED=1,STATE_NORMAL=0,DEBUG=!0,LYR_FLOORSWALLS=0,LYR_PICKUPS=1,LYR_ACTORS=2,KEY_W=87,KEY_Z=90,KEY_UP=38,KEY_A=65,KEY_Q=81,KEY_LEFT=37,KEY_S=83,KEY_DOWN=40,KEY_D=68,KEY_RIGHT=39,KEY_SPACE=32,KEY_ENTER=13,window.addEventListener("load",function(){window.engine=new Engine({W:20,H:20,A:10,P:3,debug:!1,seed:4242}),console.log(engine.render())});
