function Actor(e){function t(){this.state=STATE_AGITATED,this.glyph="A",engine.layers[o].map[h][p]=this.glyph,engine.layers[this.layer].render()}function n(){this.state=STATE_NORMAL,this.glyph="a",engine.layers[o].map[h][p]=this.glyph,engine.layers[this.layer].render()}function r(e,t){var n=this.x+e,r=this.y+t;if(Math.abs(e)>1||Math.abs(t)>1)return console.warn("WARN: actor movement range is out of range, got: %s, %s",e,t),!1;n<0&&(n=0),n>engine.width&&(n=engine.width),r<0&&(r=0),r>engine.height&&(r=engine.height);var i=engine.layers[0].map[r][n];return"#"!=i&&(engine.layers[this.layer].map[this.y][this.x]=" ",this.x=n,this.y=r,engine.layers[this.layer].map[this.y][this.x]=this.glyph,engine.layers[this.layer].render()),!0}e=e||{};var i=e.name||"ACTOR",s="a",o=e.layer||0,a=e.id||0,p=e.x||0,h=e.y||0,u=e.state||STATE_NORMAL;return{name:i,glyph:s,layer:o,id:a,x:p,y:h,state:u,agitate:t,calm:n,move:r}}function Pickup(e){e=e||{};var t=e.name||"PICKUP",n="p",r=e.layer||0,i=e.id||0,s=e.x||0,o=e.y||0,a=e.state||STATE_NORMAL;return{name:t,glyph:n,layer:r,id:i,x:s,y:o,state:a}}function Layer(e){function n(){return 0}function r(){function e(){return" ".repeat(g).split("")}for(var t=0;t<d;t++)m.push(e());return l}function i(e){switch(typeof e){case"string":console.warn("STUB: from(rendered)");break;case"object":console.warn("STUB: from(AoA)");break;default:console.warn("Layer.from(): Unsupported layer source")}}function s(e){var n=x=y=p=a=0;if(c){if("object"!=typeof e)return console.warn("WARN: invalid floorsAndWalls map"),!1;for(t=0;t<f;t++)for(n=!0,x=y=0;n;)x=h.getInt(g-1,0),y=h.getInt(d-1,0),"#"!=e[y][x]&&(L[t]=new c({layer:this.id,id:t,x:x,y:y}),n=!1,m[y][x]=L[t].glyph||"?")}else for(y=0;y<d;y++)for(x=0;x<g;x++){var r="";r=0==y||y==d-1||0==x||x==g-1?"#":+h.getFixed(2,1,0)>.75?"#":".",m[y][x]=r}return o()}function o(){for(var e="",t=0;t<d;t++){for(var n=0;n<g;n++)e+=m[t][n];e+="\n"}return e}e=e||{};var h=e.prng||new MSWS,u=e.seed||(new Date).getTime(),g=e.W||10,d=e.H||10,l=e.id||n(),c=!!e.T&&e.T||!1,f=e.N||10,m=[],L=[];return h.setSeed(u),r(),{opts:e,id:l,map:m,thing:c,things:L,uuid:n,empty:r,from:i,generate:s,render:o}}function Engine(e){function t(){var e=new Layer({W:s,H:o,prng:r,seed:i}),t="";DEBUG&&console.groupCollapsed("mergeLayer");for(var n=0;n<o;n++){for(var a=0;a<s;a++){switch(e.map[n][a]=h[LYR_FLOORSWALLS].map[n][a],DEBUG&&console.log('FW: tmpLayer.map[%s][%s]: "%s"',n,a,e.map[n][a]),e.map[n][a]){case" ":case".":case"~":" "!=h[LYR_PICKUPS].map[n][a]&&(e.map[n][a]=h[LYR_PICKUPS].map[n][a])," "!=h[LYR_ACTORS].map[n][a]&&(e.map[n][a]=h[LYR_ACTORS].map[n][a]),DEBUG&&console.log('PA: tmpLayer[%s][%s]: "%s"',n,a,e.map[n][a])}t+=e.map[n][a]}t+="\n"}return DEBUG&&console.groupEnd(),t}function n(){var e=t();return DEBUG&&(console.groupCollapsed("render"),console.log(e),console.groupEnd()),e}e=e||{};var r=e.prng||new MSWS,i=e.seed||(new Date).getTime(),s=e.W||10,o=e.H||10,a=e.P||3,p=e.A||10,h=[],u=[],g=[];return"undefined"!=typeof e.debug&&(DEBUG=e.debug),r.setSeed(i),h.push(new Layer({id:LYR_FLOORSWALLS,W:s,H:o,prng:r,seed:i})),h[LYR_FLOORSWALLS].generate(),h.push(new Layer({id:LYR_PICKUPS,W:s,H:o,N:a,T:Pickup,prng:r,seed:i})),h[LYR_PICKUPS].generate(h[LYR_FLOORSWALLS].map),u=h[LYR_PICKUPS].things,h.push(new Layer({id:LYR_ACTORS,W:s,H:o,N:p,T:Actor,prng:r,seed:i})),h[LYR_ACTORS].generate(h[LYR_FLOORSWALLS].map),g=h[LYR_ACTORS].things,{opts:e,width:s,height:o,layers:h,pickups:u,actors:g,render:n}}!function(){var e=function(){var e=function(e){this.x=0,this.w=0,this.s=e&&e.seed||1168985806,this.maxPrecision=e&&e.maxPrecision||10};return e.prototype.getSeed=function(){return this.s},e.prototype.setSeed=function(e){this.s=e},e.prototype.msws=function(e,t){var n=!!e,r=!1,i=0;for(e=e||1,t=t||0;!r;){i+=1,this.x*=this.x,this.x+=this.w+=this.s,this.x=this.x>>16|this.x<<16,this.x=this.x<0?this.x*-1:this.x;var s=n&&(this.x>e||t&&this.x<t);n?s||(r=!0):r=!0}return this.x},e.prototype.getInt=function(e,t){return this.msws(e,t)},e.prototype.getFloat=function(e,t){t=t||0,e=e||1;var n=1===e?0:this.getInt(e-1,t),r=this.getInt(1+"0".repeat(this.maxPrecision)),i=+n+"."+r;return i},e.prototype.getFixed=function(e,t,n){return e=e||2,n=n||0,t=t||1,e=e>=this.maxPrecision?this.maxPrecision:e,new Number(this.getFloat(t,n)).toFixed(e)},e.prototype.random=function(){return this.getFloat(1,0)},e}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=e:window.MSWS=e}(),STATE_NORMAL=0,STATE_AGITATED=1,STATE_NORMAL=0,DEBUG=!0,LYR_FLOORSWALLS=0,LYR_PICKUPS=1,LYR_ACTORS=2,window.addEventListener("load",function(){window.engine=new Engine({W:20,H:20,A:10,P:3,debug:!1,seed:4242}),console.log(engine.render())});
