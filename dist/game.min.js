function Actor(e){function t(){0!=this.id&&(this.state=STATE_AGITATED,this.glyph="A",engine.layers[c].map[u][p]=this.glyph,engine.layers[this.layer].render())}function n(){0!=this.id&&(this.state=STATE_NORMAL,this.glyph="a",engine.layers[c].map[u][p]=this.glyph,engine.layers[this.layer].render())}function r(e,t){var n=this.x+e,r=this.y+t;if(Math.abs(e)>1||Math.abs(t)>1)return console.warn("WARN: actor movement range is out of range, got: %s, %s",e,t),!1;n<0&&(n=0),n>engine.width&&(n=engine.width),r<0&&(r=0),r>engine.height&&(r=engine.height);var i=engine.layers[0].map[r][n];return"#"!=i&&(engine.layers[this.layer].map[this.y][this.x]=" ",this.x=n,this.y=r,engine.layers[this.layer].map[this.y][this.x]=this.glyph,engine.layers[this.layer].render()),!0}function i(e){var t=["Player","Actor1","Actor2","Actor3","Actor4","Actor5","Actor6","Actor7"];return e<t.length?t[e]:"Extra Actor"}e=e||{};var s=e.prng||new MSWS,o=(e.seed||(new Date).getTime(),e.name||"ACTOR"),a="a",c=e.layer||0,h=e.id||0,p=e.x||0,u=e.y||0,d=e.state||STATE_NORMAL;return 0==h?(a="@",hp=3):hp=s.getInt(3,1),{name:o,glyph:a,layer:c,id:h,x:p,y:u,state:d,agitate:t,calm:n,move:r,getName:i}}function Pickup(e){function t(e){var t,r=["Potion","Scroll","Sword","Gold"],i=n.getInt(100,1)-1;return t=i<35?0:i<70?1:i<90?2:3,r[t]}e=e||{};var n=e.prng||new MSWS,r=(e.seed||(new Date).getTime(),e.name||"PICKUP"),i="p",s=e.layer||0,o=e.id||0,a=e.x||0,c=e.y||0,h=e.state||STATE_NORMAL;return{name:r,glyph:i,layer:s,id:o,x:a,y:c,state:h,getName:t}}function Layer(e){function n(){return 0}function r(){function e(){return" ".repeat(u).split("")}for(var t=0;t<d;t++)f.push(e());return g}function i(e){switch(typeof e){case"string":console.warn("STUB: from(rendered)");break;case"object":console.warn("STUB: from(AoA)");break;default:console.warn("Layer.from(): Unsupported layer source")}}function s(e){var n=x=y=p=a=0;if(l){if("object"!=typeof e)return console.warn("WARN: invalid floorsAndWalls map"),!1;for(t=0;t<m;t++)for(n=!0,x=y=0;n;)if(x=c.getInt(u-1,0),y=c.getInt(d-1,0),"#"!=e[y][x]){E[t]=new l({layer:this.id,id:t,x:x,y:y,prng:c,seed:h});var r=E[t].getName(t);E[t].name=r,n=!1,f[y][x]=E[t].glyph||"?"}}else for(y=0;y<d;y++)for(x=0;x<u;x++){var i="";i=0==y||y==d-1||0==x||x==u-1?"#":+c.getFixed(2,1,0)>.75?"#":".",f[y][x]=i}return o()}function o(){for(var e="",t=0;t<d;t++){for(var n=0;n<u;n++)e+=f[t][n];e+="\n"}return e}e=e||{};var c=e.prng||new MSWS,h=e.seed||(new Date).getTime(),u=e.W||10,d=e.H||10,g=e.id||n(),l=!!e.T&&e.T||!1,m=e.N||10,f=[],E=[];return c.setSeed(h),r(),{opts:e,id:g,map:f,thing:l,things:E,uuid:n,empty:r,from:i,generate:s,render:o}}function Engine(e){function t(e){switch(e.which){case KEY_W:case KEY_Z:case KEY_UP:g[0].move(0,-1),i();break;case KEY_A:case KEY_Q:case KEY_LEFT:g[0].move(-1,0),i();break;case KEY_S:case KEY_DOWN:g[0].move(0,1),i();break;case KEY_D:case KEY_RIGHT:g[0].move(1,0),i();break;case KEY_SPACE:console.log("space");break;case KEY_ENTER:console.log("enter")}n()}function n(){for(var e=1;e<g.length;e++){var t=s.getInt(4,1)-1;0==t&&g[e].move(0,-1),1==t&&g[e].move(-1,0),2==t&&g[e].move(0,1),3==t&&g[e].move(1,0),DEBUG&&console.log("actor[%s] move direction: %s",e,t)}i()}function r(){var e=new Layer({W:a,H:c,prng:s,seed:o}),t="";DEBUG&&console.groupCollapsed("mergeLayer");for(var n=0;n<c;n++){for(var r=0;r<a;r++){switch(e.map[n][r]=u[LYR_FLOORSWALLS].map[n][r],DEBUG&&console.log('FW: tmpLayer.map[%s][%s]: "%s"',n,r,e.map[n][r]),e.map[n][r]){case" ":case".":case"~":" "!=u[LYR_PICKUPS].map[n][r]&&(e.map[n][r]=u[LYR_PICKUPS].map[n][r])," "!=u[LYR_ACTORS].map[n][r]&&(e.map[n][r]=u[LYR_ACTORS].map[n][r]),DEBUG&&console.log('PA: tmpLayer[%s][%s]: "%s"',n,r,e.map[n][r])}t+=e.map[n][r]}t+="\n"}return DEBUG&&console.groupEnd(),t}function i(){var e=r();return DEBUG&&(console.groupCollapsed("render"),console.log(e),console.groupEnd()),stage.innerText=e,e}e=e||{};var s=e.prng||new MSWS,o=e.seed||(new Date).getTime(),a=e.W||10,c=e.H||10,h=e.P||3,p=e.A||10,u=[],d=[],g=[];return"undefined"!=typeof e.debug&&(DEBUG=e.debug),s.setSeed(o),u.push(new Layer({id:LYR_FLOORSWALLS,W:a,H:c,prng:s,seed:o})),u[LYR_FLOORSWALLS].generate(),u.push(new Layer({id:LYR_PICKUPS,W:a,H:c,N:h,T:Pickup,prng:s,seed:o})),u[LYR_PICKUPS].generate(u[LYR_FLOORSWALLS].map),d=u[LYR_PICKUPS].things,u.push(new Layer({id:LYR_ACTORS,W:a,H:c,N:p,T:Actor,prng:s,seed:o})),u[LYR_ACTORS].generate(u[LYR_FLOORSWALLS].map),g=u[LYR_ACTORS].things,window.addEventListener("keydown",t),{opts:e,width:a,height:c,layers:u,pickups:d,actors:g,render:i,handleInputs:t}}!function(){var e=function(){var e=function(e){this.x=0,this.w=0,this.s=e&&e.seed||1168985806,this.maxPrecision=e&&e.maxPrecision||10};return e.prototype.getSeed=function(){return this.s},e.prototype.setSeed=function(e){this.s=e},e.prototype.msws=function(e,t){var n=!!e,r=!1,i=0;for(e=e||1,t=t||0;!r;){i+=1,this.x*=this.x,this.x+=this.w+=this.s,this.x=this.x>>16|this.x<<16,this.x=this.x<0?this.x*-1:this.x;var s=n&&(this.x>e||t&&this.x<t);n?s||(r=!0):r=!0}return this.x},e.prototype.getInt=function(e,t){return this.msws(e,t)},e.prototype.getFloat=function(e,t){t=t||0,e=e||1;var n=1===e?0:this.getInt(e-1,t),r=this.getInt(1+"0".repeat(this.maxPrecision)),i=+n+"."+r;return i},e.prototype.getFixed=function(e,t,n){return e=e||2,n=n||0,t=t||1,e=e>=this.maxPrecision?this.maxPrecision:e,new Number(this.getFloat(t,n)).toFixed(e)},e.prototype.random=function(){return this.getFloat(1,0)},e}();"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=e:window.MSWS=e}(),STATE_NORMAL=0,STATE_AGITATED=1,STATE_NORMAL=0,DEBUG=!0,LYR_FLOORSWALLS=0,LYR_PICKUPS=1,LYR_ACTORS=2,KEY_W=87,KEY_Z=90,KEY_UP=38,KEY_A=65,KEY_Q=81,KEY_LEFT=37,KEY_S=83,KEY_DOWN=40,KEY_D=68,KEY_RIGHT=39,KEY_SPACE=32,KEY_ENTER=13,window.addEventListener("load",function(){function e(e){return document.querySelector(e)}window.engine=new Engine({W:20,H:10,A:10,P:3,debug:!1,seed:4242}),e("#btn_up").addEventListener("click",function(){engine.handleInputs({which:87})}),e("#btn_lt").addEventListener("click",function(){engine.handleInputs({which:65})}),e("#btn_dn").addEventListener("click",function(){engine.handleInputs({which:83})}),e("#btn_rt").addEventListener("click",function(){engine.handleInputs({which:68})}),engine.render()});
